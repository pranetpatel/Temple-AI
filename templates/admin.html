<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Temple AI Admin Dashboard</title>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: #f4f6f8;
      margin: 0;
      padding: 2rem;
      color: #222;
    }
    h1 {
      color: #0a7;
      text-align: center;
      margin-bottom: 1.5rem;
    }
    table {
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      text-align: left;
      padding: .75rem 1rem;
      border-bottom: 1px solid #eee;
    }
    th {
      background: #0a7;
      color: #fff;
      text-transform: uppercase;
      font-size: .85rem;
      letter-spacing: .03em;
    }
    tr:last-child td { border-bottom: none; }
    td img {
      width: 70px;
      height: 70px;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 3px;
      background: #fff;
    }
    .muted { color: #666; font-size: .9rem; }
    .empty {
      text-align: center;
      padding: 2rem;
      color: #777;
      font-size: 1rem;
    }
    .topnav {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .topnav a {
      color: #0a7;
      text-decoration: none;
      font-weight: 600;
    }
    .chat-container {
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fff;
      max-width: 500px;
      margin: 2rem auto;
      display: flex;
      flex-direction: column;
      height: 400px;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: .5rem;
    }
    .chat-msg {
      padding: .5rem .75rem;
      border-radius: 6px;
      max-width: 80%;
    }
    .chat-msg.user {
      background: #e3f2fd;
      align-self: flex-end;
    }
    .chat-msg.bot {
      background: #f5f5f5;
      align-self: flex-start;
    }
    .chat-input-area {
      border-top: 1px solid #eee;
      padding: .75rem;
      display: flex;
      gap: .5rem;
    }
    .chat-input-area input {
      flex: 1;
      padding: .5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .chat-input-area button {
      padding: .5rem 1rem;
      background: #0a7;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="topnav">
    <a href="/">‚Üê Back to Registration</a>
  </div>
  <h1>Temple AI Admin Dashboard</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div>
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div style="display:flex; gap:.75rem; align-items:center; margin-bottom:1rem; flex-wrap:wrap;">
    <a href="/admin/simulate" class="btn">Simulate Attendees</a>
    <a href="/admin/reminders" class="btn" style="background:#f59e0b;color:#fff;border:none;padding:.5rem .75rem;border-radius:6px;text-decoration:none;display:inline-block;">Send Reminders</a>
    <a href="/admin/metrics" class="btn" style="background:#0984e3;color:#fff;border:none;padding:.5rem .75rem;border-radius:6px;text-decoration:none;display:inline-block;">Feedback Metrics</a>
    <a href="/admin/ai-settings" class="btn" style="background:#6c5ce7;color:#fff;border:none;padding:.5rem .75rem;border-radius:6px;text-decoration:none;display:inline-block;">AI Settings</a>
    <button type="button" id="retrain-model-btn" class="btn" style="background:#9b59b6;color:#fff;border:none;padding:.5rem .75rem;border-radius:6px;cursor:pointer;">Retrain Model</button>
    <span id="model-status" style="padding:.5rem;font-size:.9rem;color:#666;"></span>
    <form method="post" action="/admin/purge-simulated" onsubmit="return confirm('Delete all simulated users (usernames starting with sim_ or emails ending with @example.com) and related data?');" style="display:inline;">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
      <button type="submit" class="btn" style="background:#c0392b;color:#fff;border:none;padding:.5rem .75rem;border-radius:6px;cursor:pointer;">Purge Simulated Data</button>
    </form>
  </div>

  <h2>Weekly Analytics</h2>
<div style="margin-bottom:2rem">
  <canvas id="activityChart" width="600" height="240"></canvas>
  <table border="1" style="margin-top:1rem;border-collapse:collapse;width:auto;">
    <tr>
      <th>Date</th>
      <th>Signups</th>
      <th>Logins</th>
      <th>QR Scans</th>
    </tr>
    {% for i in range(days|length) %}
    <tr>
      <td>{{ days[i] }}</td>
      <td>{{ signup_counts[i] }}</td>
      <td>{{ login_counts[i] }}</td>
      <td>{{ qr_counts[i] }}</td>
    </tr>
    {% endfor %}
  </table>
</div>
<h2>Today‚Äôs Suggested Program</h2>
<div id="suggest-card" style="border:1px solid #eee;padding:1rem;border-radius:8px;margin-bottom:1.5rem;">
  <div id="suggest-loading">Loading suggestion‚Ä¶</div>
  <div id="suggest-content" style="display:none">
    <div><strong id="suggest-name"></strong></div>
    <ul id="suggest-rationale" style="margin:.5rem 0 1rem 1rem"></ul>
    <div style="display:flex; gap:.75rem; align-items:center; flex-wrap:wrap;">
      <form id="apply-form" method="post" action="/apply-program-of-day">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
        <input type="hidden" name="program_id" id="program_id" />
        <button type="submit">Apply for Today</button>
      </form>
      <a href="/program-plan" class="btn">Open Program Plan</a>
      <button type="button" id="feedback-good" style="background:#0a7;color:#fff;border:none;padding:.5rem .75rem;border-radius:6px;cursor:pointer;">Good</button>
      <button type="button" id="feedback-needs-improvement" style="background:#f59e0b;color:#fff;border:none;padding:.5rem .75rem;border-radius:6px;cursor:pointer;">Needs Improvement</button>
    </div>
  </div>
  <div id="suggest-none" style="display:none">No suggestion available.</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<!-- JSON data blobs to avoid Jinja syntax inside JS statements -->
<script type="application/json" id="signup-data">{{ signup_counts|tojson }}</script>
<script type="application/json" id="login-data">{{ login_counts|tojson }}</script>
<script type="application/json" id="qr-data">{{ qr_counts|tojson }}</script>
<script type="application/json" id="days-data">{{ days|tojson }}</script>
<script>
  var ctx = document.getElementById('activityChart').getContext('2d');
  var signupCounts = JSON.parse(document.getElementById('signup-data').textContent);
  var loginCounts = JSON.parse(document.getElementById('login-data').textContent);
  var qrCounts = JSON.parse(document.getElementById('qr-data').textContent);
  var analyticsDays = JSON.parse(document.getElementById('days-data').textContent);
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: analyticsDays,
      datasets: [
        { label: 'Signups', data: signupCounts, backgroundColor: '#0a7' },
        { label: 'Logins', data: loginCounts, backgroundColor: '#09a9f8' },
        { label: 'QR Scans', data: qrCounts, backgroundColor: '#f59e0b' }
      ]
    },
    options: {
      scales: { x: { stacked: true }, y: { stacked: true, beginAtZero:true } },
      plugins: { legend: { position: 'top' }, title: { display: true, text: 'User Activity (Last 7 Days)' } }
    }
  });
</script>
<script>
  fetch('/suggest-program', { credentials:'same-origin' }).then(r=>r.json()).then(d=>{
    const loading = document.getElementById('suggest-loading');
    const content = document.getElementById('suggest-content');
    const none = document.getElementById('suggest-none');
    loading.style.display='none';
    if(!d || d.message){ none.style.display='block'; return; }
    document.getElementById('suggest-name').textContent = d.program_name + ' (ID ' + d.program_id + ')';
    document.getElementById('program_id').value = d.program_id;
    const ul = document.getElementById('suggest-rationale');
    (d.rationale || []).forEach(t=>{ const li=document.createElement('li'); li.textContent=t; ul.appendChild(li); });
    content.style.display='block';
  }).catch(()=>{
    document.getElementById('suggest-loading').textContent='Failed to load suggestion.';
  });
</script>
<script>
  // Feedback button handlers
  function sendFeedback(label) {
    const programIdInput = document.getElementById('program_id');
    const programId = programIdInput ? programIdInput.value : null;
    
    if (!programId) {
      alert('No program selected. Please wait for a suggestion to load.');
      return;
    }
    
    const button = label === 1 ? document.getElementById('feedback-good') : document.getElementById('feedback-needs-improvement');
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = 'Sending...';
    
    fetch('/admin/feedback', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      credentials: 'same-origin',
      body: JSON.stringify({
        program_id: parseInt(programId),
        label: label
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'ok') {
        button.textContent = '‚úì ' + originalText;
        button.style.background = '#0a7';
        setTimeout(() => {
          button.textContent = originalText;
          button.style.background = label === 1 ? '#0a7' : '#f59e0b';
          button.disabled = false;
        }, 2000);
      } else {
        alert('Error: ' + (data.message || 'Failed to send feedback'));
        button.disabled = false;
        button.textContent = originalText;
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Failed to send feedback. Please try again.');
      button.disabled = false;
      button.textContent = originalText;
    });
  }
  
  // Attach event listeners when DOM is ready
  document.addEventListener('DOMContentLoaded', function() {
    const goodBtn = document.getElementById('feedback-good');
    const needsBtn = document.getElementById('feedback-needs-improvement');
    if (goodBtn) {
      goodBtn.addEventListener('click', () => sendFeedback(1));
    }
    if (needsBtn) {
      needsBtn.addEventListener('click', () => sendFeedback(-1));
    }
  });
  
  // Also try to attach immediately (in case DOM is already loaded)
  const goodBtn = document.getElementById('feedback-good');
  const needsBtn = document.getElementById('feedback-needs-improvement');
  if (goodBtn) {
    goodBtn.addEventListener('click', () => sendFeedback(1));
  }
  if (needsBtn) {
    needsBtn.addEventListener('click', () => sendFeedback(-1));
  }
</script>
<script>
  // Model retraining functionality
  function loadModelStatus() {
    fetch('/admin/model-status', { credentials: 'same-origin' })
      .then(response => response.json())
      .then(data => {
        const statusEl = document.getElementById('model-status');
        if (data.error) {
          statusEl.textContent = 'Status: Error loading';
          return;
        }
        const statusText = `Model: ${data.model_exists ? '‚úì Loaded' : '‚úó Not trained'} | Feedback: ${data.total_feedback} (${data.positive_feedback} positive, ${data.negative_feedback} negative)`;
        statusEl.textContent = statusText;
      })
      .catch(error => {
        console.error('Error loading model status:', error);
      });
  }
  
  function retrainModel() {
    const btn = document.getElementById('retrain-model-btn');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Retraining...';
    
    fetch('/admin/retrain-model', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        btn.textContent = '‚úì Retrained';
        btn.style.background = '#0a7';
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = '#9b59b6';
          btn.disabled = false;
          loadModelStatus(); // Refresh status
        }, 3000);
        // Show flash message (if using flash messages)
        alert(`Model retrained successfully!\n\nSamples: ${data.samples}\nPrograms: ${data.programs}`);
      } else {
        alert('Retraining failed: ' + (data.message || 'Unknown error'));
        btn.disabled = false;
        btn.textContent = originalText;
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Failed to retrain model. Please try again.');
      btn.disabled = false;
      btn.textContent = originalText;
    });
  }
  
  // Attach event listener
  document.addEventListener('DOMContentLoaded', function() {
    const retrainBtn = document.getElementById('retrain-model-btn');
    if (retrainBtn) {
      retrainBtn.addEventListener('click', retrainModel);
    }
    // Load model status on page load
    loadModelStatus();
  });
  
  // Also try immediately
  const retrainBtn = document.getElementById('retrain-model-btn');
  if (retrainBtn) {
    retrainBtn.addEventListener('click', retrainModel);
    loadModelStatus();
  }
</script>

  <h2>AI Assistant</h2>
  <p style="text-align:center;color:#666;">Ask questions about attendance, demographics, programs, and statistics</p>
  <div class="chat-container">
    <div class="chat-messages" id="chatMessages">
      <div class="chat-msg bot">Namaste! üëã I'm your AI assistant for the mandir. I can help you understand attendance patterns, demographics, programs, and more. Ask me anything naturally - I understand various ways of asking questions!</div>
    </div>
    <form id="chatForm" class="chat-input-area" onsubmit="sendChatMessage(event)">
      <input type="hidden" id="chatCSRF" name="csrf_token" value="{{ csrf_token }}" />
      <input type="text" id="chatInput" name="query" placeholder="Ask a question..." autocomplete="off" required />
      <button type="submit">Send</button>
    </form>
  </div>
  <script>
    function sendChatMessage(e) {
      e.preventDefault();
      const input = document.getElementById('chatInput');
      const csrfInput = document.getElementById('chatCSRF');
      const query = input.value.trim();
      if (!query) return;
      const messages = document.getElementById('chatMessages');
      messages.innerHTML += '<div class="chat-msg user">' + query + '</div>';
      input.value = '';
      messages.scrollTop = messages.scrollHeight;
      fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ query: query, csrf_token: csrfInput.value })
      }).then(r => r.json()).then(data => {
        let html = '<div class="chat-msg bot">' + data.answer.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') + '</div>';
        
        // If program suggestion, add interactive card
        if (data.type === 'program_suggestion' && data.plan) {
          const plan = data.plan;
          html += '<div class="program-card" style="border:1px solid #0a7;border-radius:8px;padding:1rem;margin-top:.5rem;background:#f9fff9;">';
          html += '<h4 style="margin-top:0;color:#0a7;">Full Program Plan</h4>';
          html += '<div><strong>Schedule:</strong><ul>';
          plan.schedule.forEach(s => html += `<li>${s.time} - ${s.item}</li>`);
          html += '</ul></div>';
          html += '<div><strong>Menu:</strong> ' + plan.menu.join(', ') + '</div>';
          html += '<div style="margin-top:.5rem;display:flex;gap:.5rem;">';
          html += '<button onclick="modifyProgram()" style="padding:.4rem .8rem;background:#f59e0b;color:#fff;border:none;border-radius:4px;cursor:pointer;">Modify</button>';
          html += '<button onclick="applyProgram()" style="padding:.4rem .8rem;background:#0a7;color:#fff;border:none;border-radius:4px;cursor:pointer;">Apply This Program</button>';
          html += '</div></div>';
        }
        
        // If menu updated, show new menu
        if (data.type === 'menu_updated' && data.menu) {
          html += '<div style="background:#e8f5e9;padding:.5rem;border-radius:4px;margin-top:.5rem;"><strong>Updated Menu:</strong> ' + data.menu.join(', ') + '</div>';
        }
        
        // If sermon updated, show new outline
        if (data.type === 'sermon_updated' && data.outline) {
          html += '<div style="background:#e3f2fd;padding:.5rem;border-radius:4px;margin-top:.5rem;"><strong>Updated Sermon Outline:</strong><ul>';
          data.outline.forEach(o => html += `<li>${o}</li>`);
          html += '</ul></div>';
        }
        
        messages.innerHTML += html;
        messages.scrollTop = messages.scrollHeight;
      }).catch(err => {
        messages.innerHTML += '<div class="chat-msg bot">Sorry, I encountered an error. Please try again.</div>';
        messages.scrollTop = messages.scrollHeight;
      });
    }
    
    function modifyProgram() {
      const input = document.getElementById('chatInput');
      input.value = 'I want to modify this program';
      input.focus();
    }
    
    function applyProgram() {
      const input = document.getElementById('chatInput');
      input.value = 'Apply this program';
      input.focus();
      // Trigger submit
      const form = document.getElementById('chatForm');
      form.dispatchEvent(new Event('submit', { cancelable: true }));
    }
  </script>

  {% if users|length > 0 %}
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Username</th>
        <th>Age</th>        <!-- Ensure Age comes first -->
        <th>Gender</th>     <!-- Gender next -->
        <th>QR Code</th>
        <th>Edit</th>
        <th>Delete</th>
      </tr>
    </thead>
    <tbody>
      {% for u in users %}
      <tr>
        <td><strong>{{ u[0] }}</strong></td>
        <td>{{ u[1] }}</td>
        <td>{{ u[2] }}</td>   <!-- Age -->
        <td>{{ u[3] }}</td>   <!-- Gender -->
        <td><a href="/scan/{{ u[1] }}" title="Simulate QR Scan"><img src="{{ u[4] }}" alt="QR for {{ u[0] }}" width="80"></a></td>
        <td>
          <a href="/admin/edit/{{ u[1] }}" class="btn btn-sm btn-primary">Edit</a>
        </td>
        <td>
          <form method="post" action="/admin/delete/{{ u[1] }}" style="display:inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Delete user {{ u[0] }}?');">Delete</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>  
  {% else %}
  <div class="empty">No users registered yet.</div>
  {% endif %}
</body>
</html>